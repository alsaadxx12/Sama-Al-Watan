rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAnonymous() {
      return isAuthenticated() && request.auth.token.firebase.sign_in_provider == 'anonymous';
    }
    
    function isStaff() {
      return isAuthenticated() && !isAnonymous();
    }

    // 1. Collections accessible by anyone authenticated (including anonymous visitors)
    // Read: All authenticated users
    // Write: Only staff
    match /settings/{id} { allow read: if isAuthenticated(); allow write: if isStaff(); }
    match /system_settings/{id} { allow read: if isAuthenticated(); allow write: if isStaff(); }
    match /system_config/{id} { allow read: if isAuthenticated(); allow write: if isStaff(); }
    match /notification_settings/{id} { allow read: if isAuthenticated(); allow write: if isStaff(); }
    match /account_settings/{id} { allow read: if isAuthenticated(); allow write: if isStaff(); }
    match /exchange_rates/{id} { allow read: if isAuthenticated(); allow write: if isStaff(); }
    
    match /courses/{id} { allow read: if isAuthenticated(); allow write: if isStaff(); }
    match /companies/{id} { allow read: if isAuthenticated(); allow write: if isStaff(); }
    match /clients/{id} { allow read: if isAuthenticated(); allow write: if isStaff(); }
    match /expenses/{id} { allow read: if isAuthenticated(); allow write: if isStaff(); }

    // 2. Collections restricted to staff only
    match /employees/{id} { allow read, write: if isStaff(); }
    match /api_connections/{id} { allow read, write: if isStaff(); }
    match /balances/{id} { allow read, write: if isStaff(); }
    match /branches/{id} { allow read, write: if isStaff(); }
    match /departments/{id} { allow read, write: if isStaff(); }
    match /permissionGroups/{id} { allow read, write: if isStaff(); }
    match /vouchers/{id} { 
      allow get: if isAuthenticated(); // Allow anonymous to see shared voucher
      allow list, create, update, delete: if isStaff(); 
    }

    match /course_applications/{id} {
      allow create: if isAuthenticated();
      allow read, update, delete: if isStaff();
    }

    // Default: Only staff can read/write everything else
    match /{document=**} {
      allow read, write: if isStaff();
    }
  }
}
